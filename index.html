<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube Final</title>
    <style>
        body { background-color: #0f0f0f; color: white; margin: 0; font-family: sans-serif; }
        header { background-color: #0f0f0f; padding: 10px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: #ff0000; font-size: 24px; font-weight: bold; }
        .container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        video { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 12px; }
        .upload-section { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { background: #cc0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:active { background: #ff0000; transform: scale(0.98); }
        .video-item { display: flex; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; background: #1a1a1a; margin-bottom: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">MyTube</div>
        <div id="status" style="font-size: 12px; color: #f1c40f;">システム準備中...</div>
    </header>

    <div class="container">
        <div class="main-content">
            <video id="mainPlayer" controls autoplay></video>
            <h2 id="currentTitle">動画を選択してください</h2>
        </div>
        <div class="sidebar">
            <div class="upload-section">
                <strong>Googleドライブに保存</strong>
                <input type="file" id="fileInput" accept="video/*">
                <input type="text" id="titleInput" placeholder="動画のタイトル">
                <button id="uploadBtn">アップロード開始</button>
                <p id="loadingMsg" style="display:none; text-align:center; color:#f1c40f; font-size:12px;"></p>
            </div>
            <div id="playlist"></div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        const CLIENT_ID = '608274366128-81rjc0e64h0qkj9rv80peeid0jioe421.apps.googleusercontent.com';
        const API_KEY = 'AQ.Ab8RN6LpPVy9Og3toEtqRzt1h5dGXaTa78fnVGyy5Bn7tyxJvQ';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;

        // 起動時に自動でAPIを準備する
        window.onload = () => {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                document.getElementById('status').innerText = "準備完了！";
                document.getElementById('status').style.color = "#00b894";
            });

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
        };

        async function uploadToDrive(file, title) {
            const msg = document.getElementById('loadingMsg');
            msg.style.display = 'block';
            msg.innerText = "Googleに接続中...";

            tokenClient.callback = async (response) => {
                if (response.error) {
                    msg.innerText = "認証に失敗しました";
                    return;
                }
                msg.innerText = "送信中...";
                try {
                    const metadata = { name: title, mimeType: file.type };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + response.access_token },
                        body: form
                    });
                    const fileData = await res.json();

                    // 公開設定
                    await fetch(`https://www.googleapis.com/drive/v3/files/${fileData.id}/permissions`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + response.access_token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: 'reader', type: 'anyone' })
                    });

                    const videoUrl = `https://www.googleapis.com/drive/v3/files/${fileData.id}?alt=media&key=${API_KEY}`;
                    
                    // リストに追加
                    const item = document.createElement('div');
                    item.className = 'video-item';
                    item.innerHTML = `<div><h4>${title}</h4></div>`;
                    item.onclick = () => {
                        document.getElementById('mainPlayer').src = videoUrl;
                        document.getElementById('currentTitle').innerText = title;
                    };
                    document.getElementById('playlist').prepend(item);

                    msg.innerText = "成功！";
                } catch (err) {
                    msg.innerText = "エラー: " + err.message;
                }
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        document.getElementById('uploadBtn').onclick = () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('titleInput').value;
            if (file && title) {
                uploadToDrive(file, title);
            } else {
                alert("ファイルとタイトルを入れてください");
            }
        };
    </script>
</body>
</html>
