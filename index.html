<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube Drive Edition</title>
    <style>
        body { background-color: #0f0f0f; color: white; margin: 0; font-family: sans-serif; }
        header { background-color: #0f0f0f; padding: 10px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: #ff0000; font-size: 24px; font-weight: bold; text-decoration: none; }
        .container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        video { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 12px; }
        .upload-section { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { background: #cc0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #loadingMsg { font-size: 14px; font-weight: bold; margin-top: 10px; }
        .video-item { display: flex; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; }
        .video-item:hover { background: #2a2a2a; }
        .thumbnail { width: 120px; height: 68px; background: #333; border-radius: 8px; flex-shrink: 0; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <a href="#" class="logo">MyTube</a>
        <div id="status" style="font-size: 12px; color: #00b894;">API Ready</div>
    </header>
    <div class="container">
        <div class="main-content">
            <video id="mainPlayer" controls></video>
            <h2 id="currentTitle">動画を選択してください</h2>
        </div>
        <div class="sidebar">
            <div class="upload-section">
                <strong>Googleドライブに保存</strong>
                <input type="file" id="fileInput" accept="video/*">
                <input type="text" id="titleInput" placeholder="動画のタイトル">
                <button id="uploadBtn">アップロード開始</button>
                <p id="loadingMsg" style="display:none; text-align:center;"></p>
            </div>
            <div id="playlist"></div>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gsiLoaded()"></script>

    <script>
        // --- 1. 設定情報の修正 (ここが最重要！) ---
        // ' 'の中に余計なスペースを入れないよう、慎重に貼り付けてください
        const CLIENT_ID = '608274366128-81rjc0e64h0qkj9rv80peeid0jioe421.apps.googleusercontent.com'; 
        const API_KEY = 'AQ.Ab8RN6LpPVy9Og3toEtqRzt1h5dGXaTa78fnVGyy5Bn7tyxJvQ'; 

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let tokenClient;

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            });
        }

        function gsiLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', 
            });
        }

        function addVideoToList(title, url) {
            const item = document.createElement('div');
            item.className = 'video-item';
            item.innerHTML = `<div class="thumbnail"></div><div><h4>${title}</h4></div>`;
            item.onclick = () => {
                document.getElementById('mainPlayer').src = url;
                document.getElementById('currentTitle').innerText = title;
                document.getElementById('mainPlayer').play();
            };
            document.getElementById('playlist').prepend(item);
        }

        async function uploadToDrive(file, title) {
            const msg = document.getElementById('loadingMsg');
            msg.style.display = 'block';
            msg.style.color = '#f1c40f';
            msg.innerText = "認証中...";

            tokenClient.callback = async (response) => {
                if (response.error) {
                    msg.style.color = 'red';
                    msg.innerText = "認証エラー: " + response.error;
                    return;
                }
                msg.innerText = "送信中...";
                try {
                    const metadata = { name: title, mimeType: file.type };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + response.access_token }),
                        body: form
                    });

                    if (!res.ok) throw new Error("送信失敗");
                    const fileData = await res.json();
                    const videoUrl = `https://www.googleapis.com/drive/v3/files/${fileData.id}?alt=media&key=${API_KEY}`;
                    addVideoToList(title, videoUrl);
                    msg.style.color = '#00b894';
                    msg.innerText = "成功！";
                } catch (err) {
                    msg.style.color = 'red';
                    msg.innerText = "エラー: " + err.message;
                }
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        document.getElementById('uploadBtn').onclick = () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('titleInput').value;
            if (file && title) uploadToDrive(file, title);
        };

        addVideoToList("サンプル動画", "https://www.w3schools.com/html/mov_bbb.mp4");
    </script>
</body>
</html>
